{% extends "database/base.html" %}
{% block content %}
    <br><br>
    <h4>Browse and Export Data</h4>
    <br>

    <div>
        <a class="btn btn-light btn-sm" href="{% url 'export_csv' %}" style="margin-right: 20px">Export All to CSV</a>
        <button class="btn btn-light btn-sm">Export Filtered to CSV</button>
    </div>

    <br>

    <div class="card">
        <h6 class="card-header">
          Filters
        </h6>
        
        <div class="card-body">
            <form method="get" action="{% url 'database-data' %}">
                <div class="row">
                    <div class="col form-group">
                        <input type="text" name="project_name" class="form-control form-select-format" placeholder="Project Name">
                        <div class="button-spacing"><br></div>
                        <input type="number" min="0" class="form-control form-select-format" placeholder="Nameplate Capacity (MW)">
                        <div class="button-spacing"><br></div>
                        <input type="number" min="0" class="form-control form-select-format" placeholder="PJM Queue Status">
                    </div>
                    <div class="col">
                        <input type="text" name="locality" class="form-control form-select-format" placeholder="Locality">
                        <div class="button-spacing"><br></div>
                        <input type="text" class="form-control form-select-format" placeholder="Project Status">
                        <div class="button-spacing"><br></div>
                        <input type="text" class="form-control form-select-format" placeholder="Local Action Date">
                        <div class="button-spacing"><br></div>
                    </div>
                    <div class="col">
                        <select class="form-select form-select-format">
                            <option selected>&#160; State Permit Status</option>
                            <option value="approved">&#160; Approved</option>
                            <option value="denied">&#160; Denied</option>
                            <option value="withdrawn">&#160; Withdrawn</option>
                            <option value="pending">&#160; Pending</option>
                            <option value="byright">&#160; By-Right</option>
                        </select>
                        <div class="button-spacing"><br></div>
                        <select class="form-select form-select-format">
                            <option selected>&#160; Local Permit Status</option>
                            <option value="approved">&#160; Approved</option>
                            <option value="denied">&#160; Denied</option>
                            <option value="withdrawn">&#160; Withdrawn</option>
                            <option value="pending">&#160; Pending</option>
                            <option value="byright">&#160; By-Right</option>
                        </select>
                        <div class="button-spacing"><br></div>
                        <input type="text" class="form-control form-select-format" placeholder="Local Zoning Submittal Date">
                        <div class="button-spacing"><br></div>
                    </div>
                    <div class="col">
                        <select class="form-select form-select-format">
                            <option selected>&#160; State Permit Path</option>
                            <option value="vdeq">&#160; Virginia Department of Environmental Quality &#160;</option>
                            <option value="scc">&#160; State Corporation Commission</option>
                        </select>
                        <div class="button-spacing"><br></div>
                        <input type="number" min="0" class="form-control form-select-format" placeholder="Project Acreage">
                        <div class="button-spacing"><br></div>
                    </div>
                </div>
                <p>
                    <button class="btn btn-light btn-sm" type="button" data-toggle="collapse" data-target="#additional-filters">
                    Additional Filters
                    </button>
                </p>
                <div style="line-height: 40%"><br></div>
                <div class="collapse" id="additional-filters">
                    <h6>Location</h6>
                    <div style="line-height: 40%"><br></div>
                    <div class="row">
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; Government Unit</option>
                                <option value="city">&#160; City</option>
                                <option value="county">&#160; County</option>
                                <option value="town">&#160; Town</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <input class="form-control form-select-format" placeholder="Tax Map Parcel #">
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <input type="number" step="0.01" min="0" class="form-control form-select-format" placeholder="Longitude">
                            <div class="button-spacing"><br></div>
                            <input type="text" class="form-control form-select-format" placeholder="Current Land Use">
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <input type="number" step="0.01" min="0" class="form-control form-select-format" placeholder="Latitude">
                            <div class="button-spacing"><br></div>
                            <input type="text" class="form-control form-select-format" placeholder="Base Zoning">
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control form-select-format" placeholder="Address">
                            <div class="button-spacing"><br></div>
                        </div>
                    </div>
                    <br>
                    <h6>Naming and Ownership</h6>
                    <div style="line-height: 40%"><br></div>
                    <div class="row">
                        <div class="col">
                            <input type="text" class="form-control form-select-format" placeholder="Alternative Name(s)">
                            <div class="button-spacing"><br></div>
                            <input type="text" class="form-control form-select-format" placeholder="Current Project Owner">
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control form-select-format" placeholder="State Permit Name (DEQ)">
                            <div class="button-spacing"><br></div>
                            <input type="text" class="form-control form-select-format" placeholder="Project Owner (At last application)">
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <input tyoe="text" class="form-control form-select-format" placeholder="Parent Project Name">
                            <div class="button-spacing"><br></div>
                            <input type="text" class="form-control form-select-format" placeholder="Previous Project Applicant">
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <input type="number" min="0" class="form-control form-select-format" placeholder="Previous Project Data ID">
                            <div class="button-spacing"><br></div>
                            <input type="number" min="0" class="form-control form-select-format" placeholder="Entity ID (EIA)">
                            <div class="button-spacing"><br></div>
                        </div>
                    </div>
                    <br>
                    <h6>Features</h6>
                    <div style="line-height: 40%"><br></div>
                    <div class="row">
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; Permit Nameplate Capacity (MW)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Lease Acreage</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Panel Type (EIA)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Agrivoltic Crop Cover</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; Parcel(s) Acreage</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Under Panel Area</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Panel Type Specified By Locality</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Apiaries</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; In Fence Area</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Battery Size</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Pollinator-Smart Features</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; Total Acreage</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Axis Design</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Sheep Grazing</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                    </div>
                    <br>
                    <h6>Local Permit Process</h6>
                    <div style="line-height: 40%"><br></div>
                    <div class="row">
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; Application Submission Date</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Executed Sitting Agreement</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; Commission Action Date</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; 2232/Comp Plan Status</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; Zoning Permit Type</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                    </div>
                    <br>
                    <h6>Generation Details</h6>
                    <div style="line-height: 40%"><br></div>
                    <div class="row">
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; Offtaker</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <input class="form-control form-select-format" placeholder="Generator ID (EIA)">
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Operating Year (EIA)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Net-Metering</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; Operator (EIA)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Interconnection (PJM)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Operation Commence (EIA)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Facility Type</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <input class="form-control form-select-format" placeholder="Plant ID (EIA)">
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Type of Interconnection (SCC)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Construction Commenced (DEQ)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; Sector (EIA)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Operating Month (EIA)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Project Classification (EIA)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                    </div>
                    <br>
                    <h6>State Permit Process</h6>
                    <div style="line-height: 40%"><br></div>
                    <div class="row">
                        <div class="col">
                            <input class="form-control form-select-format" placeholder="NOI Recieved Date">
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Interconnection Report</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; Qualifying Facility</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <input class="form-control form-select-format" placeholder="DEQ Permit #">
                            <div class="button-spacing"><br></div>
                            <input class="form-control form-select-format" placeholder="SCC CPCN #">
                            <div class="button-spacing"><br></div>
                            <input class="form-control form-select-format" placeholder="QF FERC Docket #">
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; DEQ SWM Status</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; RPC Program Compliance (SCC)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <input class="form-control form-select-format" placeholder="PJM Queue #">
                            <div class="button-spacing"><br></div>
                        </div>
                        <div class="col">
                            <select class="form-select form-select-format">
                                <option selected>&#160; State Permit Source</option>
                            </select>
                            <div class="button-spacing"><br></div>
                            <select class="form-select form-select-format">
                                <option selected>&#160; RPC Development Plan (SCC)</option>
                            </select>
                            <div class="button-spacing"><br></div>
                        </div>
                    </div>
                    <br>
                </div>
                <br>
                <button type="submit" class="btn btn-light btn-sm">Apply Filter(s)</button>
            </div>
        </form>
    </div>

    <br>

    <div class="card">
        <h6 class="card-header">
          Columns Displayed
        </h6>
        
        <div class="card-body">
            <!-- <select id="dateCategoryFilter" class="form-select form-select-format">
                <option selected>&#160; Data Category</option>
                <option value="location">&#160; Location</option>
                <option value="namingAndOwnership">&#160; Naming and Ownership</option>
                <option value="features">&#160; Features</option>
                <option value="localPermitProcess">&#160; Local Permit Process</option>
                <option value="generationDetails">&#160; Generation Details</option>
                <option value="statePermitProcess">&#160; State Permit Process</option>
            </select> 
            <br><br> -->
            <div class="form-check form-check-inline">
                <input class="form-check-input" type= "checkbox" value="" id="localityCheck">
                <label class="form-check-label" for="localityCheck">
                    Locality
                </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type= "checkbox" value="" id="statusCheck">
                <label class="form-check-label" for="statusCheck">
                    State Permit Status
                </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type= "checkbox" value="" id="pathCheck">
                <label class="form-check-label" for="pathCheck">
                    State Permit Path
                </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type= "checkbox" value="" id="capacityCheck">
                <label class="form-check-label" for="capacityCheck">
                    Nameplate Capacity (MW)
                </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type= "checkbox" value="" id="statusCheck">
                <label class="form-check-label" for="statusCheck">
                    Project Status
                </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type= "checkbox" value="" id="localCheck">
                <label class="form-check-label" for="localCheck">
                    Local Permit Status
                </label>
            </div>
            <div style="line-height: 50%"><br></div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type= "checkbox" value="" id="acreageCheck">
                <label class="form-check-label" for="acreageCheck">
                    Project Acreage
                </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type= "checkbox" value="" id="pjmCheck">
                <label class="form-check-label" for="pjmCheck">
                    PJM Queue Status
                </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type= "checkbox" value="" id="actionCheck">
                <label class="form-check-label" for="actionCheck">
                    Local Action Date
                </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type= "checkbox" value="" id="zoneCheck">
                <label class="form-check-label" for="zoneCheck">
                    Local Zoning Submittal Date
                </label>
            </div>
            <br><br>
            <button id="columnFilterButton" class="btn btn-light btn-sm" style="margin-right: 20px">Apply Column(s) Displayed</button>
        </div>
    </div>

    <div style="line-height: 300%"><br></div>

    <h5>Search Result(s)</h5>

    {{ filter|json_script:"filter_json" }}

    <div style="line-height: 85%"><br></div>

    <style> #map { height: 350px; } </style>
    <p class="card-text" id="map"></p>

    <div style="line-height: 50%"><br></div>

    <script>
        var map = L.map('map').setView([38.2, -79.2569], 7)

        let data = JSON.parse(document.getElementById('filter_json').textContent)

        var mapBase = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 20,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map)

        data.forEach(data => {
            if (data.longitude !== null && data.latitude !== null
                && data.longitude.indexOf(';') == -1 && data.latitude.indexOf(';') == -1) {
                L.marker([data.latitude, data.longitude])
                    .on('click', function() {
                        window.location.href ="/project/" + data.data_id
                    })
                    .on('mouseover', function() {
                        this.bindPopup(data.project_name).openPopup()
                    })
                    .on('mouseout', function() {
                        this.closePopup()
                    })
                    .addTo(map)
            }
        })
    </script>

    <table id="projectData" class="table table-hover">
        <thead>
            <tr>
                <th style="font-weight: 600">Project Name</th>

                <th style="font-weight: 600">Locality</th>
                <th style="font-weight: 600">County/City</th>
                <th style="font-weight: 600">Address</th>
                <th style="font-weight: 600">Tax Map Parcel #</th>
                <th style="font-weight: 600">Current Land Use</th>
                <th style="font-weight: 600">Base Zoning</th>
                <th>data_id</th>

                <th style="font-weight: 600">Alternative Name(s)</th>
                <th style="font-weight: 600">State Permit Name</th>
                <th style="font-weight: 600">Parent Project Name</th>
                <th style="font-weight: 600">Previous Project Data ID</th>
                <th style="font-weight: 600">Current Project Owner</th>
                <th style="font-weight: 600">Project Owner</th>
                <th style="font-weight: 600">Previous Project Applicant</th>
                <th style="font-weight: 600">Entity ID</th>
            </tr>
        </thead>
        <tbody>
            {% for project in data %}
            <tr>
                <td style="cursor: pointer;">{{ project.project_name }}</td>

                <td style="cursor: pointer;">{{ project.locality }}</td>
                <td style="cursor: pointer;">{{ project.city_county }}</td>
                <td style="cursor: pointer;">{{ project.address }}</td>
                <td style="cursor: pointer;">{{ project.tax_map_parcel }}</td>
                <td style="cursor: pointer;">{{ project.land_use_at_time_of_local_application }}</td>
                <td style="cursor: pointer;">{{ project.base_zoning }}</td>
                <td style="cursor: pointer;">{{ project.data_id }}</td>
                
                <td style="cursor: pointer;">{{ project.alternate_names }}</td>
                <td style="cursor: pointer;">{{ project.vdeq_emd_permit_name }}</td>
                <td style="cursor: pointer;">{{ project.parent_project }}</td>
                <td style="cursor: pointer;">{{ project.data_id_for_previous_project }}</td>
                <td style="cursor: pointer;">{{ project.current_project_owner }}</td>
                <td style="cursor: pointer;">{{ project.project_owner }}</td>
                <td style="cursor: pointer;">{{ project.previous_project_owner_applicant }}</td>
                <td style="cursor: pointer;">{{ project.entity_id_eia }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="line-height: 200%"><br></div>

    <script>
        $(document).ready(function () {
          var table = $('#projectData').DataTable({
            searching: false,
            lengthChange: false,
            scrollX: true,
            columnDefs: [
                { width: '250px', targets: 0 }, 
                { width: '100px', targets: 1 },
                { width: '100px', targets: 2 },
                { width: '500px', targets: 3 },
                { width: '200px', targets: 4 },
                { width: '200px', targets: 5 },
                { width: '200px', targets: 6 },

                { width: '350px', targets: 8 },
                { width: '200px', targets: 9 },
                { width: '200px', targets: 10 },
                { width: '200px', targets: 11 },
                { width: '200px', targets: 12 },
                { width: '200px', targets: 13 },
                { width: '200px', targets: 14 },
                { width: '100px', targets: 15 },
            ]
          });

          table.column(7).visible(false)

          table.column(8).visible(false)
          table.column(9).visible(false)
          table.column(10).visible(false)
          table.column(11).visible(false)
          table.column(12).visible(false)
          table.column(13).visible(false)
          table.column(14).visible(false)
          table.column(15).visible(false)
          
          $('#projectData tbody').on('click', 'tr', function () {
            var data = table.row(this).data();
            var data_id = data[7]
            window.location.href = '/project/' + data_id + '/';
          });
        
          var columnFilterButton = document.getElementById("columnFilterButton");
          
          columnFilterButton.addEventListener("click", function() {
            var dataCategory = document.getElementById('dateCategoryFilter').value;

            if (dataCategory == 'location') {
                table.column(1).visible(true);
                table.column(2).visible(true);
                table.column(3).visible(true);
                table.column(4).visible(true);
                table.column(5).visible(true);
                table.column(6).visible(true);

                table.column(8).visible(false);
                table.column(9).visible(false);
                table.column(10).visible(false);
                table.column(11).visible(false);
                table.column(12).visible(false);
                table.column(13).visible(false);
                table.column(14).visible(false);
                table.column(15).visible(false);
            }
            if (dataCategory == 'namingAndOwnership') {
                table.column(1).visible(false);
                table.column(2).visible(false);
                table.column(3).visible(false);
                table.column(4).visible(false);
                table.column(5).visible(false);
                table.column(6).visible(false);

                table.column(8).visible(true);
                table.column(9).visible(true);
                table.column(10).visible(true);
                table.column(11).visible(true);
                table.column(12).visible(true);
                table.column(13).visible(true);
                table.column(14).visible(true);
                table.column(15).visible(true);
            }
          });
          
        });
    </script>
      
{% endblock content %}